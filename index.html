<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A retro terminal-style life tracking application">
    <title>LIFE: TERMINAL v1.0</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a1a; /* Solid dark background, no image */
            font-family: 'VT323', monospace; /* Pure terminal font, no bold/italic */
            color: #ff9900; /* Orange text for terminal look */
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; /* Prevent scrolling */
            font-size: 16px; /* Consistent terminal readability */
        }

        .terminal, .login-screen, .loading {
            background-color: #000000; /* Solid black for all screens */
            border: 2px solid #ff9900; /* Orange border for terminal edge */
            padding: 15px;
            width: 80%;
            max-width: 800px;
            box-shadow: 0 0 10px #ff9900; /* Subtle glow */
            position: relative;
            transition: opacity 0.3s ease; /* Smooth transition for all screens */
        }

        .terminal.hidden, .login-screen.hidden, .loading.hidden {
            opacity: 0;
            pointer-events: none; /* Prevent interactions during transitions */
        }

        .header {
            text-align: right;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .user-info {
            margin-bottom: 15px;
            border: 1px solid #ff9900;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8); /* Slightly transparent for depth */
        }

        .content {
            display: none;
            padding: 10px 0;
            max-height: calc(100vh - 150px); /* Ensure content fits viewport, no scroll */
            overflow-y: auto; /* Allow internal scrolling only if content overflows (rare) */
        }

        .content.active {
            display: block;
        }

        .section {
            margin-bottom: 15px;
            border: 1px solid #ff9900; /* Solid orange border for sections */
            padding: 10px;
            background: rgba(0, 0, 0, 0.7); /* Darker for terminal depth */
        }

        .stats-item, .log-group, .goal-group {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }

        .input-field, .goal-input {
            width: 70%;
            margin: 5px 0;
            padding: 5px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #ff9900;
            color: #ff9900;
            font-family: 'VT323', monospace;
        }

        .log-button, .toggle-button, .complete-day-button, .update-goal-button {
            background: #ff6600; /* Brighter orange for buttons */
            border: 1px solid #ff9900;
            padding: 5px 10px;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.3s;
        }

        .log-button:hover, .toggle-button:hover, .complete-day-button:hover, .update-goal-button:hover {
            background: #cc5500; /* Darker orange on hover */
        }

        .achievements-grid, .daily-achievements-grid, .history-grid, .weekly-challenge-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .achievement, .daily-achievement, .history-entry, .weekly-challenge {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #ff9900;
            padding: 10px;
            text-align: center;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            gap: 10px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #ff9900;
        }

        .tab {
            background: rgba(0, 0, 0, 0.5);
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            transition: background-color 0.3s;
        }

        .tab:hover {
            background: rgba(51, 51, 51, 0.8);
        }

        .tab.active {
            background: #ff9900;
            color: #000000;
        }

        .login-screen, .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        .login-screen.active, .loading.active {
            display: block;
        }

        .login-screen .input-field, .loading p {
            width: 80%;
            margin: 10px 0;
            padding: 5px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #ff9900;
            color: #ff9900;
            font-family: 'VT323', monospace;
        }

        .login-screen button {
            background: #ff6600;
            border: 1px solid #ff9900;
            padding: 5px 10px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        .login-screen button:hover {
            background: #cc5500;
        }

        .error-message {
            color: #ff3333; /* Red for errors */
            margin-top: 10px;
            display: none;
        }

        .form-group {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="terminal" id="terminal">
        <div class="header">
            16:21:26 | 20/02/2025
        </div>

        <div class="user-info" id="userInfo">
            Name: <span id="userName">Guest</span> | 
            Age: <span id="userAge">N/A</span> | 
            Level: <span id="userLevel">1</span> | 
            XP: <span id="userXp">0/100</span>
        </div>

        <div class="tabs">
            <div class="tab" data-tab="main">MAIN</div>
            <div class="tab" data-tab="stats">STATS</div>
            <div class="tab" data-tab="achievements">ACHIEVEMENTS</div>
            <div class="tab" data-tab="history">HISTORY</div>
            <div class="tab" data-tab="settings">SETTINGS</div>
        </div>

        <div class="content main active">
            <div class="section">
                <h2>LIFE STATS MONITOR</h2>
                <div class="stats-item">Sleep Duration: <span id="sleepDuration">8h</span></div>
                <div class="stats-item">Weight: <span id="weight">78.5</span></div>
                <div class="stats-item">Steps: <span id="steps">8432</span> / <span id="stepsGoal">10000</span></div>
                <div class="stats-item">Calories: <span id="calories">2100</span> / <span id="caloriesGoal">2000</span></div>
                <div class="stats-item">Screen Time: <span id="screenTime">5.2</span></div>
                <div class="stats-item">Gym Session: <span id="gymSession">Completed</span></div>
            </div>

            <div class="section">
                <h2>INPUT CONSOLE</h2>
                <div class="log-group">
                    <input type="text" class="input-field" id="logSleepDuration" placeholder="Sleep Duration (hh)">
                    <button class="log-button" onclick="window.logStat('sleepDuration')">LOG</button>
                </div>
                <div class="log-group">
                    <input type="text" class="input-field" id="logWeight" placeholder="Weight">
                    <button class="log-button" onclick="window.logStat('weight')">LOG</button>
                </div>
                <div class="log-group">
                    <input type="text" class="input-field" id="logSteps" placeholder="Steps">
                    <button class="log-button" onclick="window.logStat('steps')">LOG</button>
                </div>
                <div class="log-group">
                    <input type="text" class="input-field" id="logCalories" placeholder="Calories">
                    <button class="log-button" onclick="window.logStat('calories')">LOG</button>
                </div>
                <div class="log-group">
                    <input type="text" class="input-field" id="logScreenTime" placeholder="Screen Time (hrs)">
                    <button class="log-button" onclick="window.logStat('screenTime')">LOG</button>
                </div>
                <button class="toggle-button" onclick="window.toggleGymSession()">TOGGLE GYM SESSION</button>
                <button class="complete-day-button" onclick="window.completeDay()">COMPLETE DAY</button>
            </div>

            <div class="section">
                <h2>DAILY ACHIEVEMENTS</h2>
                <div class="daily-achievements-grid" id="dailyAchievementsList">
                    <!-- Daily achievements will be populated via JavaScript -->
                </div>
            </div>
        </div>

        <div class="content stats">
            <div class="section">
                <h2>STATS</h2>
                <p>Steps: <span id="statsSteps">8432</span> / <span id="statsStepsGoal">10000</span> | 
                   Calories: <span id="statsCalories">2100</span> / <span id="statsCaloriesGoal">2000</span> | 
                   Sleep: <span id="statsSleep">8h</span> / <span id="statsSleepGoal">8h</span> | 
                   XP: <span id="statsXp">0</span></p>
            </div>
        </div>

        <div class="content achievements">
            <div class="section">
                <h2>ACHIEVEMENTS</h2>
                <div class="achievements-grid" id="achievementsList">
                    <!-- Achievements will be populated via JavaScript -->
                </div>
            </div>
        </div>

        <div class="content history">
            <div class="section">
                <h2>HISTORY</h2>
                <div class="history-grid" id="historyList">
                    <!-- History entries will be populated via JavaScript -->
                </div>
            </div>
        </div>

        <div class="content settings">
            <div class="section">
                <h2>SETTINGS</h2>
                <p>Profile Creation/Update:</p>
                <input type="text" class="input-field" id="editName" placeholder="Enter/Update Name">
                <button class="log-button" onclick="window.updateUserProfile('name')">UPDATE NAME</button>
                <input type="number" class="input-field" id="editAge" placeholder="Enter/Update Age">
                <button class="log-button" onclick="window.updateUserProfile('age')">UPDATE AGE</button>
                <h3>Daily Goals:</h3>
                <div class="goal-group">
                    <input type="text" class="goal-input" id="editStepsGoal" placeholder="Steps Goal (e.g., 10000)">
                    <button class="update-goal-button" onclick="window.updateGoal('steps')">UPDATE</button>
                </div>
                <div class="goal-group">
                    <input type="text" class="goal-input" id="editCaloriesGoal" placeholder="Calories Goal (e.g., 2000)">
                    <button class="update-goal-button" onclick="window.updateGoal('calories')">UPDATE</button>
                </div>
                <div class="goal-group">
                    <input type="text" class="goal-input" id="editSleepGoal" placeholder="Sleep Goal (hh, e.g., 8)">
                    <button class="update-goal-button" onclick="window.updateGoal('sleep')">UPDATE</button>
                </div>
                <h3>Weekly Gym Challenge:</h3>
                <div class="goal-group">
                    <input type="text" class="goal-input" id="editGymGoal" placeholder="Gym Sessions/Week (e.g., 3)">
                    <button class="update-goal-button" onclick="window.updateGoal('gym')">UPDATE</button>
                </div>
                <div class="weekly-challenge-grid" id="weeklyChallengeList">
                    <!-- Weekly challenge will be populated via JavaScript -->
                </div>
                <p>Theme: Dark | Notifications: On</p>
                <button class="log-button" onclick="window.logout()">LOGOUT</button>
            </div>
        </div>
    </div>

    <div class="login-screen" id="loginScreen">
        <h2>LOGIN</h2>
        <div class="form-group">
            <input type="text" class="input-field" id="loginUsername" placeholder="Email" required>
            <div class="error-message" id="loginError">Invalid email or password.</div>
        </div>
        <div class="form-group">
            <input type="password" class="input-field" id="loginPassword" placeholder="Password" required>
        </div>
        <button onclick="window.login()">LOGIN</button>
        <button onclick="window.showRegister()">REGISTER</button>
    </div>

    <div class="login-screen" id="registerScreen" style="display: none;">
        <h2>REGISTER</h2>
        <div class="form-group">
            <input type="text" class="input-field" id="registerUsername" placeholder="Email" required>
            <div class="error-message" id="registerError">Email already in use or invalid format.</div>
        </div>
        <div class="form-group">
            <input type="password" class="input-field" id="registerPassword" placeholder="Password" required>
        </div>
        <button onclick="window.register()">REGISTER</button>
        <button onclick="window.showLogin()">BACK TO LOGIN</button>
    </div>

    <div class="loading" id="loadingScreen">
        <p>Loading...</p>
    </div>

    <script type="module">
        // Import Firebase SDK as ES Modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Your Firebase configuration (replace with your project's config)
        const firebaseConfig = {
            apiKey: "AIzaSyAF89yo2wqizIfKbBqycGjFI-p5u25XLmY",
            authDomain: "life-terminal.firebaseapp.com",
            projectId: "life-terminal",
            storageBucket: "life-terminal.firebasestorage.app",
            messagingSenderId: "543173954166",
            appId: "1:543173954166:web:c6a5d8e0c17cb31843ad57"
          };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let userProfile = {
            name: "Guest",
            age: "N/A"
        };

        let stats = {
            level: 1,
            xp: 0,
            maxXp: 100,
            sleepDuration: "8h",
            weight: "78.5",
            steps: "8432",
            calories: "2100",
            screenTime: "5.2",
            gymSession: "Completed",
            logs: [],
            dayCompleted: false,
            gymSessionsThisWeek: 0
        };

        let goals = {
            steps: "10000",
            calories: "2000",
            sleep: "8",
            gymWeekly: "3"
        };

        let achievements = [
            { name: "Early Bird", status: "IN PROGRESS" },
            { name: "Gym Warrior", status: "IN PROGRESS" },
            { name: "Nutrition Master", status: "IN PROGRESS" },
            { name: "Step Master", status: "IN PROGRESS" },
            { name: "Sleep Guardian", status: "IN PROGRESS" },
            { name: "Digital Wellness", status: "IN PROGRESS" }
        ];

        let dailyAchievements = [
            { name: "Morning Jog", status: "IN PROGRESS", xp: 20, condition: "steps >= 10000" },
            { name: "Healthy Meal", status: "IN PROGRESS", xp: 15, condition: "calories >= 2000" },
            { name: "Screen Break", status: "IN PROGRESS", xp: 10, condition: "screenTime <= 4" }
        ];

        let history = [];
        let weekStart = new Date();
        weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);

        // Screen management functions
        function showScreen(screenId, hideOthers = true) {
            const screens = ['terminal', 'loginScreen', 'registerScreen', 'loadingScreen'];
            screens.forEach(id => {
                const screen = document.getElementById(id);
                if (id === screenId) {
                    screen.classList.add('active');
                    screen.classList.remove('hidden');
                    setTimeout(() => screen.style.opacity = '1', 0); // Ensure visibility
                } else if (hideOthers) {
                    screen.classList.remove('active');
                    screen.style.opacity = '0';
                    screen.classList.add('hidden');
                }
            });
        }

        function showLoading() {
            showScreen('loadingScreen', false);
        }

        function hideLoading() {
            const loading = document.getElementById('loadingScreen');
            loading.classList.remove('active');
            loading.classList.add('hidden');
            loading.style.opacity = '0';
        }

        // Load or save data to Firestore with async/await for smoother handling
        async function loadData() {
            showLoading();
            const user = auth.currentUser;
            if (user) {
                try {
                    const userDoc = doc(db, 'users', user.uid);
                    const docSnap = await getDoc(userDoc);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        userProfile = data.userProfile || userProfile;
                        stats = data.stats || stats;
                        goals = data.goals || goals;
                        achievements = data.achievements || achievements;
                        dailyAchievements = data.dailyAchievements || dailyAchievements;
                        history = data.history || history;
                        checkDailyReset();
                        checkWeeklyReset();
                        updateDisplay();
                        renderAchievements();
                        renderDailyAchievements();
                        renderHistory();
                        renderWeeklyChallenge();
                    } else {
                        await saveData(); // Initialize new user data if none exists
                    }
                } catch (error) {
                    console.error("Error loading data:", error);
                    alert("Failed to load data. Please check your internet connection or try again later.");
                } finally {
                    hideLoading();
                    showScreen('terminal');
                }
            } else {
                hideLoading();
                showScreen('loginScreen');
            }
            return Promise.resolve();
        }

        async function saveData() {
            showLoading();
            const user = auth.currentUser;
            if (user) {
                try {
                    const userDoc = doc(db, 'users', user.uid);
                    await setDoc(userDoc, {
                        userProfile: userProfile,
                        stats: stats,
                        goals: goals,
                        achievements: achievements,
                        dailyAchievements: dailyAchievements,
                        history: history
                    }, { merge: true });
                    console.log("Data saved successfully");
                } catch (error) {
                    console.error("Error saving data:", error);
                    alert("Failed to save data. Please check your internet connection or try again later.");
                    throw error;
                } finally {
                    hideLoading();
                }
            } else {
                hideLoading();
                showScreen('loginScreen');
                throw new Error("User not authenticated");
            }
            return Promise.resolve();
        }

        // Check if daily achievements need to reset
        function checkDailyReset() {
            const today = new Date().toDateString();
            const lastReset = localStorage.getItem('lastDailyReset');
            if (lastReset !== today) {
                dailyAchievements.forEach(ach => ach.status = "IN PROGRESS");
                stats.logs = [];
                stats.dayCompleted = false;
                stats.gymSession = "Not Completed";
                localStorage.setItem('lastDailyReset', today);
                saveData();
            }
        }

        // Check if weekly gym challenge needs to reset
        function checkWeeklyReset() {
            const now = new Date();
            const currentWeekStart = new Date(weekStart);
            if (now.getTime() >= currentWeekStart.getTime() + 7 * 24 * 60 * 60 * 1000) {
                stats.gymSessionsThisWeek = 0;
                weekStart = new Date(now);
                weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
                saveData();
            }
        }

        // Update display for stats and user info
        function updateDisplay() {
            const user = auth.currentUser;
            if (user) {
                document.getElementById('userName').textContent = userProfile.name || 'Guest';
                document.getElementById('userAge').textContent = userProfile.age || 'N/A';
                document.getElementById('userLevel').textContent = stats.level;
                document.getElementById('userXp').textContent = `${stats.xp}/${stats.maxXp}`;
                document.getElementById('sleepDuration').textContent = stats.sleepDuration || '8h';
                document.getElementById('weight').textContent = stats.weight || '--';
                document.getElementById('steps').textContent = stats.steps || '0';
                document.getElementById('stepsGoal').textContent = goals.steps;
                document.getElementById('calories').textContent = stats.calories || '0';
                document.getElementById('caloriesGoal').textContent = goals.calories;
                document.getElementById('screenTime').textContent = stats.screenTime || '0';
                document.getElementById('gymSession').textContent = stats.gymSession || 'Not Completed';
                
                // Update stats tab
                document.getElementById('statsSteps').textContent = stats.steps || '0';
                document.getElementById('statsStepsGoal').textContent = goals.steps;
                document.getElementById('statsCalories').textContent = stats.calories || '0';
                document.getElementById('statsCaloriesGoal').textContent = goals.calories;
                document.getElementById('statsSleep').textContent = stats.sleepDuration || '8h';
                document.getElementById('statsSleepGoal').textContent = goals.sleep;
                document.getElementById('statsXp').textContent = stats.xp || '0';
            }
        }

        // Render achievements with status
        function renderAchievements() {
            const achievementsList = document.getElementById('achievementsList');
            achievementsList.innerHTML = '';
            achievements.forEach(ach => {
                const div = document.createElement('div');
                div.className = 'achievement';
                div.innerHTML = `${ach.name}\n${ach.status}`;
                achievementsList.appendChild(div);
            });
        }

        // Render daily achievements
        function renderDailyAchievements() {
            const dailyList = document.getElementById('dailyAchievementsList');
            dailyList.innerHTML = '';
            dailyAchievements.forEach(ach => {
                const div = document.createElement('div');
                div.className = 'daily-achievement';
                div.innerHTML = `${ach.name} (+${ach.xp} XP)\n${ach.status}`;
                dailyList.appendChild(div);
            });
        }

        // Render history (including today's stats if day is completed)
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            const today = new Date().toDateString();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toDateString();

            if (stats.dayCompleted) {
                const todayEntry = {
                    date: today,
                    sleepDuration: stats.sleepDuration,
                    weight: stats.weight,
                    steps: stats.steps,
                    calories: stats.calories,
                    screenTime: stats.screenTime,
                    gymSession: stats.gymSession
                };
                const todayDiv = document.createElement('div');
                todayDiv.className = 'history-entry';
                todayDiv.innerHTML = `Date: ${todayEntry.date}\n` +
                    `Sleep: ${todayEntry.sleepDuration || '8h'}\n` +
                    `Weight: ${todayEntry.weight || '--'}\n` +
                    `Steps: ${todayEntry.steps || '0'}\n` +
                    `Calories: ${todayEntry.calories || '0'}\n` +
                    `Screen: ${todayEntry.screenTime || '0'}\n` +
                    `Gym: ${todayEntry.gymSession || 'Not Completed'}`;
                historyList.appendChild(todayDiv);
            }

            const yesterdayEntries = history.filter(entry => entry.date === yesterdayStr);
            if (yesterdayEntries.length > 0) {
                yesterdayEntries.forEach(entry => {
                    const div = document.createElement('div');
                    div.className = 'history-entry';
                    div.innerHTML = `Date: ${entry.date}\n` +
                        `Sleep: ${entry.sleepDuration || '8h'}\n` +
                        `Weight: ${entry.weight || '--'}\n` +
                        `Steps: ${entry.steps || '0'}\n` +
                        `Calories: ${entry.calories || '0'}\n` +
                        `Screen: ${entry.screenTime || '0'}\n` +
                        `Gym: ${entry.gymSession || 'Not Completed'}`;
                    historyList.appendChild(div);
                });
            } else if (!stats.dayCompleted) {
                historyList.innerHTML = 'No history available. Complete the day to save today\'s stats.';
            }
        }

        // Render weekly gym challenge
        function renderWeeklyChallenge() {
            const challengeList = document.getElementById('weeklyChallengeList');
            challengeList.innerHTML = '';
            const div = document.createElement('div');
            div.className = 'weekly-challenge';
            div.innerHTML = `Weekly Gym Goal: ${stats.gymSessionsThisWeek}/${goals.gymWeekly} sessions\nWeek: ${weekStart.toDateString()} - ${new Date(weekStart.getTime() + 6 * 24 * 60 * 60 * 1000).toDateString()}`;
            challengeList.appendChild(div);
        }

        // Check and update daily achievements
        function checkDailyAchievements() {
            dailyAchievements.forEach(ach => {
                if (ach.status === "IN PROGRESS") {
                    let conditionMet = false;
                    switch (ach.condition) {
                        case "steps >= 10000":
                            conditionMet = parseInt(stats.steps) >= 10000;
                            break;
                        case "calories >= 2000":
                            conditionMet = parseInt(stats.calories) >= 2000;
                            break;
                        case "screenTime <= 4":
                            conditionMet = parseFloat(stats.screenTime) <= 4;
                            break;
                        default:
                            if (ach.condition.startsWith("steps >= ")) {
                                const value = parseInt(ach.condition.split('>= ')[1]);
                                conditionMet = parseInt(stats.steps) >= value;
                            } else if (ach.condition.startsWith("calories >= ")) {
                                const value = parseInt(ach.condition.split('>= ')[1]);
                                conditionMet = parseInt(stats.calories) >= value;
                            }
                    }
                    if (conditionMet) {
                        ach.status = "COMPLETED";
                        stats.xp += ach.xp;
                    }
                }
            });
            renderDailyAchievements();
            saveData();
        }

        // Award XP and update achievements
        function awardXp(steps = null, calories = null, screenTime = null, gymSession = null, sleepDuration = null) {
            let xpGain = 0;
            if (steps && parseInt(steps) >= parseInt(goals.steps)) xpGain += 20;
            if (calories && parseInt(calories) >= parseInt(goals.calories)) xpGain += 15;
            if (screenTime && parseFloat(screenTime) <= 4) xpGain += 10;
            if (gymSession === "Completed") xpGain += 25;
            if (sleepDuration) {
                const [hours] = sleepDuration.split('h').map(Number);
                const sleepGoal = parseInt(goals.sleep);
                if (hours >= 7 && hours <= 9 && hours === sleepGoal) xpGain += 15;
            }

            stats.xp += xpGain;
            while (stats.xp >= stats.maxXp) {
                stats.xp -= stats.maxXp;
                stats.level += 1;
                stats.maxXp += 50;
            }
            saveData();
        }

        // Update achievements progress
        function updateAchievements() {
            achievements.forEach(ach => {
                if (ach.status === "IN PROGRESS") {
                    const today = new Date().toDateString();
                    const lastUpdate = localStorage.getItem(`last${ach.name}Update`) || '';
                    if (lastUpdate !== today) {
                        switch (ach.name) {
                            case "Early Bird":
                            case "Sleep Guardian":
                                const [hours] = stats.sleepDuration.split('h').map(Number);
                                if (hours >= 7 && hours <= 9 && hours === parseInt(goals.sleep)) ach.status = "COMPLETED";
                                break;
                            case "Gym Warrior":
                                if (stats.gymSession === "Completed" && stats.gymSessionsThisWeek >= parseInt(goals.gymWeekly)) ach.status = "COMPLETED";
                                break;
                            case "Nutrition Master":
                                if (parseInt(stats.calories) >= parseInt(goals.calories)) ach.status = "COMPLETED";
                                break;
                            case "Step Master":
                                if (parseInt(stats.steps) >= parseInt(goals.steps)) ach.status = "COMPLETED";
                                break;
                            case "Digital Wellness":
                                if (parseFloat(stats.screenTime) <= 4) ach.status = "COMPLETED";
                                break;
                        }
                        localStorage.setItem(`last${ach.name}Update`, today);
                    }
                }
            });
            renderAchievements();
            saveData();
        }

        // Intuitive logging system
        window.logStat = function(statType) {
            if (!auth.currentUser) {
                window.showLogin();
                return;
            }
            showLoading();
            const inputId = `log${statType.charAt(0).toUpperCase() + statType.slice(1)}`;
            const value = document.getElementById(inputId).value;
            if (value && !isNaN(value)) {
                stats[statType] = value + (statType === 'sleepDuration' ? 'h' : '');
                stats.logs.push({ timestamp: new Date().toLocaleTimeString(), type: statType, value });
                if (statType === 'gymSession' && stats.gymSession === "Completed") {
                    stats.gymSessionsThisWeek++;
                }
                awardXp(statType === 'steps' ? value : null,
                        statType === 'calories' ? value : null,
                        statType === 'screenTime' ? value : null,
                        statType === 'gymSession' ? stats.gymSession : null,
                        statType === 'sleepDuration' ? value : null);
                document.getElementById(inputId).value = '';
                saveData().then(() => {
                    updateDisplay();
                    updateAchievements();
                    checkDailyAchievements();
                    renderWeeklyChallenge();
                    hideLoading();
                }).catch((error) => {
                    console.error("Error saving log:", error);
                    alert("Failed to save log. Please try again.");
                    hideLoading();
                });
            } else {
                alert("Please enter a valid number.");
                hideLoading();
            }
        };

        window.toggleGymSession = function() {
            if (!auth.currentUser) {
                window.showLogin();
                return;
            }
            showLoading();
            stats.gymSession = stats.gymSession === "Completed" ? "Not Completed" : "Completed";
            stats.logs.push({ timestamp: new Date().toLocaleTimeString(), type: "gymSession", value: stats.gymSession });
            if (stats.gymSession === "Completed") {
                stats.gymSessionsThisWeek++;
            }
            awardXp(null, null, null, stats.gymSession);
            saveData().then(() => {
                updateDisplay();
                updateAchievements();
                checkDailyAchievements();
                renderWeeklyChallenge();
                hideLoading();
            }).catch((error) => {
                console.error("Error toggling gym session:", error);
                alert("Failed to update gym session. Please try again.");
                hideLoading();
            });
        };

        // Update user profile
        window.updateUserProfile = function(field) {
            if (!auth.currentUser) {
                window.showLogin();
                return;
            }
            showLoading();
            const inputId = `edit${field.charAt(0).toUpperCase() + field.slice(1)}`;
            const value = document.getElementById(inputId).value;
            if (value) {
                if (field === 'name' && value.trim().length > 0) {
                    userProfile.name = value.trim();
                } else if (field === 'age' && !isNaN(value) && value > 0) {
                    userProfile.age = parseInt(value);
                } else {
                    alert("Please enter a valid name or age (positive number).");
                    hideLoading();
                    return;
                }
                document.getElementById(inputId).value = '';
                saveData().then(() => {
                    updateDisplay();
                    hideLoading();
                }).catch((error) => {
                    console.error("Error updating profile:", error);
                    alert("Failed to update profile. Please try again.");
                    hideLoading();
                });
            } else {
                alert("Please enter a value.");
                hideLoading();
            }
        };

        // Update goals
        window.updateGoal = function(goalType) {
            if (!auth.currentUser) {
                window.showLogin();
                return;
            }
            showLoading();
            const inputId = `edit${goalType.charAt(0).toUpperCase() + goalType.slice(1)}Goal`;
            const value = document.getElementById(inputId).value;
            if (value && !isNaN(value) && value > 0) {
                if (goalType === 'steps' || goalType === 'calories' || goalType === 'gym') {
                    goals[goalType] = value;
                } else if (goalType === 'sleep') {
                    goals.sleep = value;
                }
                document.getElementById(inputId).value = '';
                saveData().then(() => {
                    updateDisplay();
                    // Update daily achievement conditions as strings
                    dailyAchievements[0].condition = `steps >= ${goals.steps}`;
                    dailyAchievements[1].condition = `calories >= ${goals.calories}`;
                    dailyAchievements[2].condition = `screenTime <= 4`; // Screen Break unchanged
                    updateAchievements(); // Re-evaluate achievements based on new goals
                    hideLoading();
                }).catch((error) => {
                    console.error("Error updating goal:", error);
                    alert("Failed to update goal. Please try again.");
                    hideLoading();
                });
            } else {
                alert("Please enter a valid positive number for the goal.");
                hideLoading();
            }
        };

        // Complete day and save history
        window.completeDay = function() {
            if (!auth.currentUser) {
                window.showLogin();
                return;
            }
            showLoading();
            const today = new Date().toDateString();
            const dailyEntry = {
                date: today,
                sleepDuration: stats.sleepDuration,
                weight: stats.weight,
                steps: stats.steps,
                calories: stats.calories,
                screenTime: stats.screenTime,
                gymSession: stats.gymSession
            };
            history.push(dailyEntry);
            stats.logs = [];
            stats.dayCompleted = true;
            stats.gymSession = "Not Completed";
            checkDailyReset();
            saveData().then(() => {
                updateDisplay();
                renderHistory();
                hideLoading();
            }).catch((error) => {
                console.error("Error completing day:", error);
                alert("Failed to complete day. Please try again.");
                hideLoading();
            });
        };

        // Login and registration functions with validation
        window.login = function() {
            showLoading();
            const email = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) {
                alert("Please enter both email and password.");
                hideLoading();
                return;
            }
            if (!isValidEmail(email)) {
                document.getElementById('loginError').style.display = 'block';
                hideLoading();
                return;
            }
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    loadData().then(() => {
                        showScreen('terminal');
                        updateDisplay();
                        document.getElementById('loginError').style.display = 'none';
                        hideLoading();
                    });
                })
                .catch((error) => {
                    console.error("Login error:", error);
                    document.getElementById('loginError').style.display = 'block';
                    alert("Login failed: " + error.message);
                    hideLoading();
                });
        };

        window.showRegister = function() {
            showScreen('registerScreen');
            document.getElementById('registerError').style.display = 'none';
        };

        window.register = function() {
            showLoading();
            const email = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            if (!email || !password) {
                alert("Please enter both email and password.");
                hideLoading();
                return;
            }
            if (!isValidEmail(email)) {
                document.getElementById('registerError').style.display = 'block';
                hideLoading();
                return;
            }
            if (password.length < 6) {
                alert("Password must be at least 6 characters long.");
                hideLoading();
                return;
            }
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    setDoc(doc(db, 'users', user.uid), {
                        userProfile: { name: email.split('@')[0], age: 25 },
                        stats: {
                            level: 1,
                            xp: 0,
                            maxXp: 100,
                            sleepDuration: "8h",
                            weight: "78.5",
                            steps: "8432",
                            calories: "2100",
                            screenTime: "5.2",
                            gymSession: "Completed",
                            logs: [],
                            dayCompleted: false,
                            gymSessionsThisWeek: 0
                        },
                        goals: {
                            steps: "10000",
                            calories: "2000",
                            sleep: "8",
                            gymWeekly: "3"
                        },
                        achievements: [
                            { name: "Early Bird", status: "IN PROGRESS" },
                            { name: "Gym Warrior", status: "IN PROGRESS" },
                            { name: "Nutrition Master", status: "IN PROGRESS" },
                            { name: "Step Master", status: "IN PROGRESS" },
                            { name: "Sleep Guardian", status: "IN PROGRESS" },
                            { name: "Digital Wellness", status: "IN PROGRESS" }
                        ],
                        dailyAchievements: [
                            { name: "Morning Jog", status: "IN PROGRESS", xp: 20, condition: "steps >= 10000" },
                            { name: "Healthy Meal", status: "IN PROGRESS", xp: 15, condition: "calories >= 2000" },
                            { name: "Screen Break", status: "IN PROGRESS", xp: 10, condition: "screenTime <= 4" }
                        ],
                        history: []
                    }).then(() => {
                        userProfile = { name: email.split('@')[0], age: 25 };
                        showScreen('loginScreen');
                        updateDisplay();
                        document.getElementById('registerError').style.display = 'none';
                        hideLoading();
                    });
                })
                .catch((error) => {
                    console.error("Registration error:", error);
                    document.getElementById('registerError').style.display = 'block';
                    alert("Registration failed: " + error.message);
                    hideLoading();
                });
        };

        window.showLogin = function() {
            showScreen('loginScreen');
            document.getElementById('loginError').style.display = 'none';
        };

        window.logout = function() {
            showLoading();
            signOut(auth)
                .then(() => {
                    userProfile = { name: "Guest", age: "N/A" };
                    stats = {
                        level: 1,
                        xp: 0,
                        maxXp: 100,
                        sleepDuration: "8h",
                        weight: "78.5",
                        steps: "8432",
                        calories: "2100",
                        screenTime: "5.2",
                        gymSession: "Not Completed",
                        logs: [],
                        dayCompleted: false,
                        gymSessionsThisWeek: 0
                    };
                    updateDisplay();
                    window.showLogin();
                    hideLoading();
                })
                .catch((error) => {
                    console.error("Logout failed:", error);
                    alert("Logout failed. Please try again.");
                    hideLoading();
                });
        };

        // Email validation
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Tab switching (with login check)
        const tabs = document.querySelectorAll('.tab');
        const contents = document.querySelectorAll('.content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                if (!auth.currentUser) {
                    window.showLogin();
                    return;
                }
                tabs.forEach(t => t.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.querySelector(`.content.${tabId}`).classList.add('active');
                console.log(`Switched to ${tabId} tab at ${new Date().toLocaleTimeString()}`);
            });
        });

        // Ensure login screen shows on load if not authenticated
        document.addEventListener('DOMContentLoaded', () => {
            showLoading();
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    loadData().then(() => {
                        showScreen('terminal');
                        hideLoading();
                    });
                } else {
                    hideLoading();
                    showScreen('loginScreen');
                }
            });
        });

        // Initialize (handled by auth state listener)
        document.querySelector('.tab[data-tab="main"]').classList.add('active');
    </script>
</body>
</html>